<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á–µ—Ç #{{ work_id }} - AntiPlagiat</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .progress-container {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 25px;
            color: #333;
            font-weight: bold;
            text-shadow: 0 0 2px white;
        }

        .similarity-level {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
        }

        .level {
            padding: 3px 8px;
            border-radius: 4px;
        }

        .low { background: #d4edda; color: #155724; }
        .medium { background: #fff3cd; color: #856404; }
        .high { background: #f8d7da; color: #721c24; }

        .result-description {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä –û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞–±–æ—Ç—ã</h1>
            <a href="/" class="btn-back">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∑–∞–≥—Ä—É–∑–∫–µ</a>
        </header>

        <div id="report-content">
            <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞...</div>
        </div>

        <div class="actions">
            <button onclick="refreshReport()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button onclick="window.print()" class="btn">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            <button onclick="closeReport()" class="btn">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const workId = {{ work_id }};
        const PLAGIARISM_THRESHOLD = 70; // –ü–æ—Ä–æ–≥ –ø–ª–∞–≥–∏–∞—Ç–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö

        function getSimilarityLevel(similarity) {
            if (similarity < 30) return { class: 'low', text: '–ù–∏–∑–∫–∞—è' };
            if (similarity < 70) return { class: 'medium', text: '–°—Ä–µ–¥–Ω—è—è' };
            return { class: 'high', text: '–í—ã—Å–æ–∫–∞—è' };
        }

        function getColorBySimilarity(similarity) {
            if (similarity < 30) return '#28a745'; // –ó–µ–ª–µ–Ω—ã–π
            if (similarity < 50) return '#ffc107'; // –ñ–µ–ª—Ç—ã–π
            if (similarity < 70) return '#fd7e14'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            return '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π
        }

        function getDescriptionBySimilarity(similarity) {
            if (similarity < 10) return '–†–∞–±–æ—Ç—ã –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –∏–º–µ—é—Ç –æ–±—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤.';
            if (similarity < 30) return '–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –≤–µ—Ä–æ—è—Ç–Ω–æ —Å–ª—É—á–∞–π–Ω—ã–µ.';
            if (similarity < 50) return '–£–º–µ—Ä–µ–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –≤–æ–∑–º–æ–∂–Ω–æ –æ–±—â–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.';
            if (similarity < 70) return '–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è.';
            if (similarity < 90) return '–í—ã—Å–æ–∫–∞—è —Å—Ç–µ–ø–µ–Ω—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –≤–µ—Ä–æ—è—Ç–µ–Ω –ø–ª–∞–≥–∏–∞—Ç.';
            return '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è —Å—Ç–µ–ø–µ–Ω—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, —è–≤–Ω—ã–π –ø–ª–∞–≥–∏–∞—Ç.';
        }

        async function loadReport() {
            try {
                const response = await fetch(`/works/${workId}/report`);
                const report = await response.json();

                const contentDiv = document.getElementById('report-content');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –æ—Ç—á–µ—Ç –µ—â–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è
                if (report.status === 'processing') {
                    contentDiv.innerHTML = `
                        <div class="processing">
                            <h2>‚è≥ –û—Ç—á–µ—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è</h2>
                            <p>–†–∞–±–æ—Ç–∞ #${workId} –≤—Å–µ –µ—â–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</p>
                            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</p>
                            <div class="spinner"></div>
                        </div>
                    `;
                    return;
                }

                // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                const similarity = report.similarity_percentage || (report.plagiarism_score * 100).toFixed(2);
                const similarityNum = parseFloat(similarity);
                const level = getSimilarityLevel(similarityNum);
                const color = getColorBySimilarity(similarityNum);
                const description = getDescriptionBySimilarity(similarityNum);
                const isPlagiarism = report.is_plagiarism || similarityNum >= PLAGIARISM_THRESHOLD;

                let plagiarismStatus = '';
                if (isPlagiarism) {
                    plagiarismStatus = `
                        <div class="plagiarism-detected">
                            <div class="warning-icon">‚ö†Ô∏è</div>
                            <h3>–í–´–°–û–ö–ê–Ø –°–•–û–ñ–ï–°–¢–¨ –û–ë–ù–ê–†–£–ñ–ï–ù–ê!</h3>
                            <div class="progress-container">
                                <p><strong>–ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è:</strong></p>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${similarityNum}%; background: ${color};">
                                        <div class="progress-text">${similarityNum.toFixed(2)}%</div>
                                    </div>
                                </div>
                                <div class="similarity-level">
                                    <span class="level low">–ù–∏–∑–∫–∞—è (<30%)</span>
                                    <span class="level medium">–°—Ä–µ–¥–Ω—è—è (30-69%)</span>
                                    <span class="level high">–í—ã—Å–æ–∫–∞—è (‚â•70%)</span>
                                </div>
                                <div class="result-description" style="background: ${color}20;">
                                    ${description}
                                </div>
                            </div>
                            <div class="plagiarism-details">
                                <p><strong>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ—Ä:</strong> ${report.original_author || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                                <p><strong>ID –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã:</strong> ${report.matched_work_id || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                                <p><strong>–§–∞–π–ª –æ—Ä–∏–≥–∏–Ω–∞–ª–∞:</strong> ${report.matched_file_name || report.original_file || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                                <p class="small">–ü–æ—Ä–æ–≥ –ø–ª–∞–≥–∏–∞—Ç–∞: ${PLAGIARISM_THRESHOLD}%</p>
                            </div>
                        </div>
                    `;
                } else {
                    plagiarismStatus = `
                        <div class="plagiarism-clean">
                            <div class="success-icon">‚úÖ</div>
                            <h3>–ü–õ–ê–ì–ò–ê–¢ –ù–ï –û–ë–ù–ê–†–£–ñ–ï–ù</h3>
                            <div class="progress-container">
                                <p><strong>–°—Ö–æ–∂–µ—Å—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ —Ä–∞–±–æ—Ç–∞–º–∏:</strong></p>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${Math.min(similarityNum, 100)}%; background: ${color};">
                                        <div class="progress-text">${similarityNum.toFixed(2)}%</div>
                                    </div>
                                </div>
                                <div class="similarity-level">
                                    <span class="level low">–ù–∏–∑–∫–∞—è (<30%)</span>
                                    <span class="level medium">–°—Ä–µ–¥–Ω—è—è (30-69%)</span>
                                    <span class="level high">–í—ã—Å–æ–∫–∞—è (‚â•70%)</span>
                                </div>
                                <div class="result-description" style="background: ${color}20;">
                                    ${description}
                                </div>
                            </div>
                            <p class="small">–ü–æ—Ä–æ–≥ –ø–ª–∞–≥–∏–∞—Ç–∞: ${PLAGIARISM_THRESHOLD}%</p>
                        </div>
                    `;
                }

                let wordCloudSection = '';
                if (report.word_cloud_url && report.word_cloud_url.startsWith('http')) {
                    wordCloudSection = `
                        <div class="word-cloud-section">
                            <h3>‚òÅÔ∏è –û–±–ª–∞–∫–æ —Å–ª–æ–≤</h3>
                            <div class="word-cloud-container">
                                <img src="${report.word_cloud_url}" alt="–û–±–ª–∞–∫–æ —Å–ª–æ–≤"
                                     onerror="this.style.display='none'">
                                <p class="small">–ß–∞—Å—Ç–æ—Ç–∞ —Å–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ —Ä–∞–±–æ—Ç—ã</p>
                            </div>
                        </div>
                    `;
                }

                let hashAnalysis = '';
                if (report.file_hash) {
                    hashAnalysis = `
                        <div class="detail">
                            <strong>üîê –•–µ—à —Ñ–∞–π–ª–∞ (SHA-256):</strong>
                            <div class="hash-container">
                                <code class="hash">${report.file_hash}</code>
                                <p class="small">–•–µ—à –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤</p>
                            </div>
                        </div>
                    `;
                }

                contentDiv.innerHTML = `
                    <div class="report-card">
                        <div class="report-header">
                            <h2>–†–∞–±–æ—Ç–∞ #${report.work_id}</h2>
                            <span class="report-date">${new Date(report.created_at).toLocaleString('ru-RU')}</span>
                        </div>

                        <div class="report-details">
                            <div class="detail-row">
                                <div class="detail">
                                    <strong>üë§ –°—Ç—É–¥–µ–Ω—Ç:</strong>
                                    <span>${report.student_name}</span>
                                </div>
                                <div class="detail">
                                    <strong>üìö –ó–∞–¥–∞–Ω–∏–µ:</strong>
                                    <span>${report.assignment_id}</span>
                                </div>
                            </div>

                            <div class="detail-row">
                                <div class="detail">
                                    <strong>üìÑ –§–∞–π–ª:</strong>
                                    <span>${report.file_name}</span>
                                </div>
                                <div class="detail">
                                    <strong>üìÖ –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:</strong>
                                    <span>${new Date(report.created_at).toLocaleDateString('ru-RU')}</span>
                                </div>
                            </div>

                            ${hashAnalysis}
                        </div>

                        <div class="plagiarism-section">
                            <h3>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø–ª–∞–≥–∏–∞—Ç</h3>
                            ${plagiarismStatus}
                        </div>

                        ${wordCloudSection}

                        <div class="analysis-info">
                            <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–Ω–∞–ª–∏–∑–µ</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>–ú–µ—Ç–æ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:</strong>
                                    <span>–¢–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ (SequenceMatcher)</span>
                                </div>
                                <div class="info-item">
                                    <strong>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ä–∞–±–æ—Ç:</strong>
                                    <span>${report.total_compared || '–í—Å–µ –≤ —Å–∏—Å—Ç–µ–º–µ'}</span>
                                </div>
                                <div class="info-item">
                                    <strong>–í–µ—Ä–¥–∏–∫—Ç:</strong>
                                    <span>${isPlagiarism ? '–ü–õ–ê–ì–ò–ê–¢' : '–£–ù–ò–ö–ê–õ–¨–ù–ê'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                document.getElementById('report-content').innerHTML = `
                    <div class="error">
                        ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞: ${error.message}
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ ID —Ä–∞–±–æ—Ç—ã</p>
                    </div>
                `;
            }
        }

        function refreshReport() {
            document.getElementById('report-content').innerHTML = '<div class="loading">‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</div>';
            loadReport();
        }

        function closeReport() {
            window.close();
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadReport();
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥, –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å processing
        setInterval(loadReport, 5000);
    </script>
</body>
</html>